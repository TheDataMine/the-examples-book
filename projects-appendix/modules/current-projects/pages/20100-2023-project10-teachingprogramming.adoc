= TDM 20100: Project 10 -- 2023

**Motivation:** Being able to use results of queries as tables in new queries (also known as writing sub-queries), and calculating values like `MIN`, `MAX`, and `AVG` in aggregate are key skills to have in order to write more complex queries. In this project we will learn about aliasing, writing sub-queries, and calculating aggregate values.

**Context:** We are in the middle of a series of projects focused on working with databases and SQL. In this project we introduce aliasing, sub-queries, and calculating aggregate values!

**Scope:** SQL, SQL in R

.Learning Objectives
****
- Demonstrate the ability to interact with popular database management systems within R.
- Solve data-driven problems using a combination of SQL and R.
- Basic clauses: SELECT, ORDER BY, LIMIT, DESC, ASC, COUNT, WHERE, FROM, etc.
- Showcase the ability to filter, alias, and write subqueries.
- Perform grouping and aggregate data using group by and the following functions: COUNT, MAX, SUM, AVG, LIKE, HAVING. Explain when to use having, and when to use where.
****

Make sure to read about, and use the template found xref:templates.adoc[here], and the important information about projects submissions xref:submissions.adoc[here].

== Dataset(s)

For this project, we will be using the `lahman` sqlite database. This database contains the data in the directory  

- `/anvil/projects/tdm/data/lahman`

You may get some more `lahman` database information from this youtube video http://youtube.com/watch?v=tS_-oTbsDzs
[2023 SABR Analytics:Sean Lahman, "introduction to Baseball Databases"]

To run SQL queries in a Jupyter Lab notebook, first run the following in a cell at the top of your notebook to establish a connection with the database.

[source,python]
----
%sql sqlite:////anvil/projects/tdm/data/lahman/lahman.db
----

For every following cell where you want to run a SQL query, prepend `%%sql` to the top of the cell -- just like we do for R or bash cells.

== Questions

=== Question 1 (1 pt)

[loweralpha]
.. Let's say we are interested in the total number of baseball players for each year from year 2018 to year 2022 respectively. Please write a query to count the number of players in the appearance table and display the totals in descending order by year. 

.output
year num_of_players

2022  1495

...

[TIP]
====
* In the query, please name `yearID` from `appearance` table an `alias` as `year`, and name the counting of distinct players an `alias` as `num_of_players`. The `alias` is a great way to not only make the headers look good, but it can also be used to reduce the text in a query by giving some intermediate results a shorter name. Following is the basic syntax of column alias. You may get more information from https://www.tutorialspoint.com/sqlite/sqlite_alias_syntax.htm [alias]

SELECT column_name AS alias_name
FROM table_name
WHERE [condition];

* Example code  
[source,sql]
select count(distinct playerID) as num_of_players from appearances group by yearID

====


=== Question 2 (2 pts)

Now, let's look into `teams` table, the field `attendance` provides the total number of audiences that attended a team's home games. We may say a team is more popular if it has more audiences attended its home games.

.. Please find out what is the average number of attendance for the games from `teams` table at year 2022

.. Using the functions from previous questions, write a query to list each team name and the total attendance for that team, add a condition to this query to only display teams where their total attendance is more than the average total attendance for the full league. 
    Hint: we found this value in the previous query.
    Using an alias, change the attendance column in your query to appear as “total_num_of_audience”.
... Which team is the most popular team in terms of attendance in 2022?
 
[TIP]
`avg` function will be useful to calculate average attendance 
[TIP]
We can achieve this using a _subquery_. A subquery is a query that is used to get a smaller result set from a larger result set. Use the query from `question a`, _add_ it to the query for `question b` 
 

=== Question 3 (1 pt)

If you answered question (2) correctly, you should find that team `Los Angeles Dodgers`, with team ID 'LAN`, had the most audiences. We can consider this team as the most popular team in 2022.

.. Please calculate the winning percentage for this team in 2022 using the fields 'W' and `L` from the teams table with the formula:

[source]
----
winning_percentage = W/(W+L)
----

[IMPORTANT]
====
Some of you might get a `0` in your output and wonder why the most popular baseball team had a `0` win percentage! What's happening here?
====

[NOTE]
====
The `AS` keyword can _also_ be used to _cast_ types, which some might be familiar with from other programming languages. In many languages, there are "integer" types (numeric data without a decimal place) and "float" types (numeric data with a decimal place). If you simply use `W/(W+L)`, you might encounter unexpected output since both values are integers, truncating the decimal place. This truncation results in the observed `0`.

An example fix is:

[source, sql]
----
select cast (W as real)/(cast(W as real)+cast(L as real))
----

Here, "real" signifies "float" or "double" - indicating a number with a decimal place.
====

[IMPORTANT]
====
Performing arithmetic with an integer and a real/float will yield a real/float result. This explains why our result is a real number even though half of our values are integers.
====

=== Question 4 (1 pt)

..  Please review and, if necessary, update your query from the previous question. Rename the percentage column to `winning_per` using the `alias` feature.


[NOTE]
====
You can read more about `sqlite3` types https://www.sqlite.org/datatype3.html[here]. In a lot of ways, the `sqlite3` typing system is simpler than typical RDBMS systems, and it other ways it is more complex. `sqlite3` considers their flexible typing https://www.sqlite.org/flextypegood.html[a feature]. However, `sqlite3` does provide https://www.sqlite.org/stricttables.html[strict tables] for individuals who want a more stringent set of typing rules.
====


=== Question 5 (1 pt)

You now know 2 different applications of the `AS` keyword, and you also know how to use a query as a subquery, great!

In the previous project, we were introduced to aggregate functions. We know we can use the `WHERE` clause to filter our results, but what if we wanted to filter our results based on an aggregated column?

.. Update the query from question (4) to print all teams that have average winning percentage from year 2012 to 2022 (year 2012 and 2022 should be included) greater than 55%. You should get 4 teams. Display the results by average win percentage in descending order

[TIP]
====
See https://www.geeksforgeeks.org/having-vs-where-clause-in-sql/[this article] for more information on the `HAVING` and `WHERE` clauses.
====


=== Question 6 (2 pts)

.. Now let's look at `allstarfull` table, please list all players who attended all star games more than 20 times. List by descending order of attending times
.. Please explore tables and write a query with the information you interested at. Please make sure to use aliasing, subquery and at least one aggregate function. 

 Project 10 Assignment Checklist
====
* Jupyter notebook with your code, comments and output for questions 1 to 5
    ** `firstname-lastname-project10.ipynb`
* Submit files through Gradescope
====


[WARNING]
====
_Please_ make sure to double check that your submission is complete, and contains all of your code and output before submitting. If you are on a spotty internet connection, it is recommended to download your submission after submitting it to make sure what you _think_ you submitted, was what you _actually_ submitted.
                                                                                                                             
In addition, please review our xref:submissions.adoc[submission guidelines] before submitting your project.
====

